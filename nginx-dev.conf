# Development Nginx Configuration for Attendance Dashboard
# Location: /usr/local/etc/nginx/servers/attendance-dev.conf (macOS)
# Location: /etc/nginx/sites-available/attendance-dev (Linux)

# Upstream configuration for Node.js backend
upstream backend_dev {
    server 127.0.0.1:3002;
    keepalive 32;
}

# Development server block
server {
    listen 8080;
    server_name localhost attendance-dev.local;
    
    # Security headers (relaxed for development)
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Request size limits
    client_max_body_size 10M;
    
    # Root directory for React build
    root /Users/salarjirjees/Desktop/myrecipe/attendance-dashboard/frontend/build;
    index index.html;
    
    # Enable gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # API routes - Proxy to Node.js backend
    location /api/ {
        proxy_pass http://backend_dev;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS headers for development
        add_header Access-Control-Allow-Origin 'http://localhost:8080' always;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-Requested-With' always;
        
        # Disable caching for API responses
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
    }
    
    # Socket.IO WebSocket support
    location /socket.io/ {
        proxy_pass http://backend_dev;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Static files with basic caching
    location /static/ {
        expires 1d;
        add_header Cache-Control "public";
    }
    
    # React Router - Serve index.html for all routes
    location / {
        try_files $uri $uri/ /index.html;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }
    
    # Favicon
    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }
    
    # Health check
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    # Logging (less verbose for development)
    access_log /usr/local/var/log/nginx/attendance-dev_access.log;
    error_log /usr/local/var/log/nginx/attendance-dev_error.log warn;
}
